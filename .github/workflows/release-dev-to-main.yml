name: RELEASE — Dev → Main

on:
  workflow_dispatch:
    inputs:
      checks_profile:
        description: "Checks — Profile (full=all standard checks, fast=skip slow builds/smoke, none=skip all checks, custom=use toggles below)"
        required: true
        type: choice
        default: full
        options:
          - full
          - fast
          - none
          - custom
      run_e2e_core:
        description: "Checks (custom) — Run core E2E gate (packages/tests, pglite+sqlite)"
        required: true
        default: true
        type: boolean
      run_providers:
        description: "Checks — Run providers contract suite (requires provider secrets)"
        required: true
        default: false
        type: boolean
      providers_preset:
        description: "Checks (Providers) — Preset"
        required: true
        default: all
        type: choice
        options:
          - all
          - claude
          - codex
          - opencode
      providers_tier:
        description: "Checks (Providers) — Tier"
        required: true
        default: smoke
        type: choice
        options:
          - smoke
          - extended
      run_stress:
        description: "Checks (custom) — Run stress suite (slow)"
        required: true
        default: false
        type: boolean
      cli_smoke_linux:
        description: "Checks (custom) — Run CLI smoke test on Linux"
        required: true
        default: true
        type: boolean
      build_website:
        description: "Checks (custom) — Build website as part of release checks"
        required: true
        default: true
        type: boolean
      build_docs:
        description: "Checks (custom) — Build docs as part of release checks"
        required: true
        default: true
        type: boolean
      dry_run:
        description: "Safety — Run checks and show plan, but do not push/deploy"
        required: true
        default: false
        type: boolean
      promote_mode:
        description: "Promotion — How to update main from dev"
        required: true
        type: choice
        default: fast_forward
        options:
          - fast_forward
          - reset
      allow_reset:
        description: "Promotion — Required when promote_mode=reset (rewrites main history)"
        required: true
        default: false
        type: boolean
      sync_dev_from_main:
        description: "Promotion — Fast-forward dev to main after version bumps (keeps future releases fast-forwardable)"
        required: true
        default: true
        type: boolean
      environment:
        description: "Deploy — Target environment (deploy/<env>/*)"
        required: true
        type: choice
        default: preview
        options:
          - preview
          - production
      deploy_ui:
        description: "Deploy — Promote deploy/<env>/ui (web deploy on push)"
        required: true
        default: true
        type: boolean
      ui_expo_action:
        description: "Deploy — UI Expo action (none|ota|native|native_submit) for the selected environment"
        required: true
        default: none
        type: choice
        options:
          - none
          - ota
          - native
          - native_submit
      ui_expo_profile:
        description: "Deploy — UI EAS build profile (auto recommended)"
        required: true
        default: auto
        type: choice
        options:
          - auto
          - preview
          - production
      ui_expo_platform:
        description: "Deploy — UI Expo native platform"
        required: true
        default: ios
        type: choice
        options:
          - ios
          - android
          - all
      deploy_server:
        description: "Deploy — Promote deploy/<env>/server"
        required: true
        default: true
        type: boolean
      deploy_website:
        description: "Deploy — Promote deploy/<env>/website"
        required: true
        default: true
        type: boolean
      deploy_docs:
        description: "Deploy — Promote deploy/<env>/docs"
        required: true
        default: true
        type: boolean
      bump:
        description: "Versions — Version bump to apply (only for changed components)"
        required: true
        type: choice
        default: none
        options:
          - none
          - patch
          - minor
          - major
      cli_bump:
        description: "Publish — Publish CLI to npm (none=skip)"
        required: true
        type: choice
        default: none
        options:
          - none
          - patch
          - minor
          - major
      stack_bump:
        description: "Publish — Publish Stack to npm (none=skip)"
        required: true
        type: choice
        default: none
        options:
          - none
          - patch
          - minor
          - major
      confirm:
        description: "Confirm — Choose the exact action"
        required: true
        type: choice
        options:
          - release dev to main
          - reset main from dev

permissions:
  contents: read

concurrency:
  group: release-dev-to-main
  cancel-in-progress: false

jobs:
  gate:
    name: CI Gate (dev)
    if: inputs.checks_profile != 'none'
    uses: ./.github/workflows/tests.yml
    secrets: inherit
    with:
      run_ui: true
      run_server: true
      run_cli: true
      run_stack: true
      run_typecheck: true
      run_cli_daemon_e2e: true
      run_e2e_core: ${{ inputs.checks_profile == 'full' || (inputs.checks_profile == 'custom' && inputs.run_e2e_core) }}
      run_providers: ${{ inputs.checks_profile != 'none' && inputs.run_providers }}
      providers_preset: ${{ inputs.providers_preset }}
      providers_tier: ${{ inputs.providers_tier }}
      providers_strict_keys: false
      providers_flake_retry: true
      providers_update_baselines: false
      run_stress: ${{ inputs.checks_profile == 'custom' && inputs.run_stress }}
      stress_repeat: "5"
      stress_seed: ""

  checks:
    needs: [gate]
    if: ${{ always() && (needs.gate.result == 'success' || needs.gate.result == 'skipped') }}
    runs-on: ubuntu-latest
    outputs:
      changed_ui: ${{ steps.plan.outputs.changed_ui }}
      changed_cli: ${{ steps.plan.outputs.changed_cli }}
      changed_server: ${{ steps.plan.outputs.changed_server }}
      changed_website: ${{ steps.plan.outputs.changed_website }}
      changed_docs: ${{ steps.plan.outputs.changed_docs }}
      changed_shared: ${{ steps.plan.outputs.changed_shared }}
      changed_stack: ${{ steps.plan.outputs.changed_stack }}
    steps:
      - name: Validate inputs
        run: |
          set -euo pipefail
          mode="${{ inputs.promote_mode }}"
          confirm="${{ inputs.confirm }}"

          if [ "$mode" = "fast_forward" ]; then
            expected="release dev to main"
            if [ "$confirm" != "$expected" ]; then
              echo "Confirmation mismatch." >&2
              echo "Expected: $expected" >&2
              echo "Got:      $confirm" >&2
              exit 1
            fi
          elif [ "$mode" = "reset" ]; then
            if [ "${{ inputs.allow_reset }}" != "true" ]; then
              echo "Refusing to reset without allow_reset=true." >&2
              exit 1
            fi
            expected="reset main from dev"
            if [ "$confirm" != "$expected" ]; then
              echo "Confirmation mismatch." >&2
              echo "Expected: $expected" >&2
              echo "Got:      $confirm" >&2
              exit 1
            fi
          else
            echo "Unknown promote_mode: $mode" >&2
            exit 1
          fi

      - name: Create GitHub App token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - name: Checkout dev
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
          token: ${{ steps.app_token.outputs.token }}

      - name: Setup Node
        if: ${{ (inputs.checks_profile == 'full') || (inputs.checks_profile == 'custom' && (inputs.build_website || inputs.build_docs || inputs.cli_smoke_linux)) }}
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Enable Corepack (Yarn)
        if: ${{ (inputs.checks_profile == 'full') || (inputs.checks_profile == 'custom' && (inputs.build_website || inputs.build_docs || inputs.cli_smoke_linux)) }}
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate

      - name: Install dependencies
        if: ${{ (inputs.checks_profile == 'full') || (inputs.checks_profile == 'custom' && (inputs.build_website || inputs.build_docs || inputs.cli_smoke_linux)) }}
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: yarn install --frozen-lockfile --ignore-engines

      - name: Test + typecheck
        if: inputs.checks_profile != 'none'
        run: |
          set -euo pipefail
          echo "CI gate ran in job 'gate' (tests/typecheck/e2e/providers/stress as configured)."

      - name: Build website
        if: ${{ (inputs.checks_profile == 'full') || (inputs.checks_profile == 'custom' && inputs.build_website) }}
        run: yarn website:build

      - name: Build docs
        if: ${{ (inputs.checks_profile == 'full') || (inputs.checks_profile == 'custom' && inputs.build_docs) }}
        run: yarn docs:build

      - name: CLI smoke test (Linux)
        if: ${{ (inputs.checks_profile == 'full') || (inputs.checks_profile == 'custom' && inputs.cli_smoke_linux) }}
        run: |
          set -euo pipefail
          yarn workspace @happier-dev/cli build
          rm -f /tmp/happier-dev-cli-*.tgz
          (cd apps/cli && npm pack --silent --pack-destination /tmp)

          PACKAGE_FILE="$(ls /tmp/happier-dev-cli-*.tgz 2>/dev/null | head -n 1)"
          if [ -z "${PACKAGE_FILE:-}" ]; then
            echo "Unable to find packed CLI tarball in /tmp/happier-dev-cli-*.tgz" >&2
            exit 1
          fi

          npm install -g "$PACKAGE_FILE"

          timeout 30s happier --help
          timeout 10s happier --version
          timeout 30s happier doctor
          timeout 10s happier daemon status

      - name: Compute changed components (main..dev)
        id: plan
        run: |
          set -euo pipefail

          git fetch origin main dev --prune --tags

          dev_sha="$(git rev-parse HEAD)"
          main_sha="$(git rev-parse origin/main)"

          commit_count="$(git rev-list --count "$main_sha..$dev_sha" 2>/dev/null || echo 0)"
          git diff --name-only "$main_sha..$dev_sha" > /tmp/changed_paths.txt || true

          changed_ui=false
          changed_cli=false
          changed_server=false
          changed_website=false
          changed_docs=false
          changed_shared=false
          changed_stack=false

          while IFS= read -r p; do
            case "$p" in
              apps/ui/*) changed_ui=true ;;
              apps/cli/*) changed_cli=true ;;
              apps/server/*) changed_server=true ;;
              apps/stack/*) changed_stack=true ;;
              apps/website/*) changed_website=true ;;
              apps/docs/*) changed_docs=true ;;
              packages/agents/*|packages/protocol/*) changed_shared=true ;;
              *) ;;
            esac
          done < /tmp/changed_paths.txt

          echo "changed_ui=$changed_ui" >> "$GITHUB_OUTPUT"
          echo "changed_cli=$changed_cli" >> "$GITHUB_OUTPUT"
          echo "changed_server=$changed_server" >> "$GITHUB_OUTPUT"
          echo "changed_stack=$changed_stack" >> "$GITHUB_OUTPUT"
          echo "changed_website=$changed_website" >> "$GITHUB_OUTPUT"
          echo "changed_docs=$changed_docs" >> "$GITHUB_OUTPUT"
          echo "changed_shared=$changed_shared" >> "$GITHUB_OUTPUT"

          {
            echo "## Release plan (dev → main)"
            echo ""
            echo "- checks_profile: \`${{ inputs.checks_profile }}\`"
            echo "- environment: \`${{ inputs.environment }}\`"
            echo "- promote_mode: \`${{ inputs.promote_mode }}\`"
            echo "- dry_run: \`${{ inputs.dry_run }}\`"
            echo "- bump: \`${{ inputs.bump }}\`"
            echo "- cli_bump: \`${{ inputs.cli_bump }}\`"
            echo "- stack_bump: \`${{ inputs.stack_bump }}\`"
            echo "- ui_expo_action: \`${{ inputs.ui_expo_action }}\` (platform=\`${{ inputs.ui_expo_platform }}\`, profile=\`${{ inputs.ui_expo_profile }}\`)"
            echo ""
            echo "- commits to release (main..dev): \`$commit_count\`"
            echo ""
            echo "### Changed components (main..dev)"
            echo "- ui: \`$changed_ui\`"
            echo "- cli: \`$changed_cli\`"
            echo "- server: \`$changed_server\`"
            echo "- stack: \`$changed_stack\`"
            echo "- website: \`$changed_website\`"
            echo "- docs: \`$changed_docs\`"
            echo "- shared (agents/protocol): \`$changed_shared\`"
          } >> "$GITHUB_STEP_SUMMARY"

  deploy_plan:
    name: deploy_plan (main → deploy branches)
    runs-on: ubuntu-latest
    if: always()
    needs: [checks, promote_main, bump_versions]
    outputs:
      deploy_ui_needed: ${{ steps.plan.outputs.deploy_ui_needed }}
      deploy_server_needed: ${{ steps.plan.outputs.deploy_server_needed }}
      deploy_website_needed: ${{ steps.plan.outputs.deploy_website_needed }}
      deploy_docs_needed: ${{ steps.plan.outputs.deploy_docs_needed }}
    steps:
      - name: Create GitHub App token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ steps.app_token.outputs.token }}

      - name: Compute deploy plan (deploy/<env>/* behind main?)
        id: plan
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          DEPLOY_UI: ${{ inputs.deploy_ui }}
          DEPLOY_SERVER: ${{ inputs.deploy_server }}
          DEPLOY_WEBSITE: ${{ inputs.deploy_website }}
          DEPLOY_DOCS: ${{ inputs.deploy_docs }}
        run: |
          set -euo pipefail

          env_name="${ENVIRONMENT}"

          main_ref="main"
          main_sha="$(git rev-parse HEAD)"
          git fetch origin "${main_ref}" --prune --tags
          main_sha="$(git rev-parse "origin/${main_ref}")"

          ui_ref="deploy/${env_name}/ui"
          server_ref="deploy/${env_name}/server"
          website_ref="deploy/${env_name}/website"
          docs_ref="deploy/${env_name}/docs"

          git fetch origin "${ui_ref}" "${server_ref}" "${website_ref}" "${docs_ref}" --prune || true

          plan_one() {
            local key="$1"
            local deploy_ref="$2"
            local enabled="$3"
            shift 3
            local -a patterns=("$@")

            local deploy_sha=""
            deploy_sha="$(git rev-parse "origin/${deploy_ref}" 2>/dev/null || true)"
            if [ -z "${deploy_sha:-}" ]; then
              printf -v "${key}_needed" '%s' "false"
              printf -v "${key}_commits" '%s' "0"
              printf -v "${key}_relevant_changes" '%s' "false"
              echo "${key}_needed=false" >> "$GITHUB_OUTPUT"
              echo "${key}_commits=0" >> "$GITHUB_OUTPUT"
              return 0
            fi

            local commits=""
            commits="$(git rev-list --count "${deploy_sha}..${main_sha}" 2>/dev/null || echo 0)"

            local base=""
            base="$(git merge-base "${deploy_sha}" "${main_sha}" 2>/dev/null || true)"
            if [ -z "${base:-}" ]; then
              base="${deploy_sha}"
            fi

            local changed=false
            if [ "${commits}" != "0" ]; then
              git diff --name-only "${base}..${main_sha}" > "/tmp/changed_${key}.txt" || true
              while IFS= read -r p; do
                for pat in "${patterns[@]}"; do
                  case "$p" in
                    $pat) changed=true ;;
                    *) ;;
                  esac
                  if [ "${changed}" = "true" ]; then
                    break
                  fi
                done
                if [ "${changed}" = "true" ]; then
                  break
                fi
              done < "/tmp/changed_${key}.txt"
            fi

            local needed=false
            if [ "${enabled}" = "true" ] && [ "${commits}" != "0" ] && [ "${changed}" = "true" ]; then
              needed=true
            fi

            printf -v "${key}_needed" '%s' "${needed}"
            printf -v "${key}_commits" '%s' "${commits}"
            printf -v "${key}_relevant_changes" '%s' "${changed}"

            echo "${key}_needed=${needed}" >> "$GITHUB_OUTPUT"
            echo "${key}_commits=${commits}" >> "$GITHUB_OUTPUT"
            echo "${key}_relevant_changes=${changed}" >> "$GITHUB_OUTPUT"
          }

          plan_one "deploy_ui" "${ui_ref}" "${DEPLOY_UI}" "apps/ui/*" "packages/agents/*" "packages/protocol/*"
          plan_one "deploy_server" "${server_ref}" "${DEPLOY_SERVER}" "apps/server/*" "packages/agents/*" "packages/protocol/*"
          plan_one "deploy_website" "${website_ref}" "${DEPLOY_WEBSITE}" "apps/website/*"
          plan_one "deploy_docs" "${docs_ref}" "${DEPLOY_DOCS}" "apps/docs/*"

          {
            echo "## Deploy plan (main → deploy branches)"
            echo ""
            echo "- environment: \`${env_name}\`"
            echo "- origin/main: \`${main_sha}\`"
            echo ""
            echo "| component | enabled | deploy ref | commits behind | relevant changes | will run |"
            echo "|---|---:|---|---:|---:|---:|"
            echo "| ui | \`${DEPLOY_UI}\` | \`${ui_ref}\` | \`${deploy_ui_commits}\` | \`${deploy_ui_relevant_changes}\` | \`${deploy_ui_needed}\` |"
            echo "| server | \`${DEPLOY_SERVER}\` | \`${server_ref}\` | \`${deploy_server_commits}\` | \`${deploy_server_relevant_changes}\` | \`${deploy_server_needed}\` |"
            echo "| website | \`${DEPLOY_WEBSITE}\` | \`${website_ref}\` | \`${deploy_website_commits}\` | \`${deploy_website_relevant_changes}\` | \`${deploy_website_needed}\` |"
            echo "| docs | \`${DEPLOY_DOCS}\` | \`${docs_ref}\` | \`${deploy_docs_commits}\` | \`${deploy_docs_relevant_changes}\` | \`${deploy_docs_needed}\` |"
          } >> "$GITHUB_STEP_SUMMARY"

  promote_main:
    if: inputs.dry_run != true
    needs: [checks]
    uses: ./.github/workflows/promote-branch.yml
    secrets: inherit
    with:
      source: dev
      target: main
      mode: ${{ inputs.promote_mode }}
      dry_run: ${{ inputs.dry_run }}
      allow_reset: ${{ inputs.allow_reset }}
      confirm: ${{ inputs.promote_mode == 'reset' && 'reset main from dev' || 'promote main from dev' }}

  bump_versions:
    if: inputs.dry_run != true
    needs: [checks, promote_main]
    runs-on: ubuntu-latest
    steps:
      - name: Decide if we need version bumps
        id: decide
        run: |
          set -euo pipefail
          if [ "${{ inputs.bump }}" != "none" ] || [ "${{ inputs.cli_bump }}" != "none" ] || [ "${{ inputs.stack_bump }}" != "none" ]; then
            echo "should_bump=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_bump=false" >> "$GITHUB_OUTPUT"
            echo "No version bumps requested." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Create GitHub App token
        if: steps.decide.outputs.should_bump == 'true'
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - name: Checkout main
        if: steps.decide.outputs.should_bump == 'true'
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ steps.app_token.outputs.token }}

      - name: Setup Node
        if: steps.decide.outputs.should_bump == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Enable Corepack (Yarn)
        if: steps.decide.outputs.should_bump == 'true'
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate

      - name: Install dependencies
        if: steps.decide.outputs.should_bump == 'true'
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: yarn install --frozen-lockfile --ignore-engines

      - name: Apply version bumps (single commit)
        if: steps.decide.outputs.should_bump == 'true'
        id: bumps
        run: |
          set -euo pipefail

          bump="${{ inputs.bump }}"
          bumped=()

          if [ "$bump" != "none" ]; then
            if [ "${{ needs.checks.outputs.changed_ui }}" = "true" ] || [ "${{ needs.checks.outputs.changed_shared }}" = "true" ]; then
              node scripts/release/bump-version.mjs --component app --bump "$bump" >/tmp/bump_app.txt
              bumped+=("app")
            fi
            if [ "${{ needs.checks.outputs.changed_server }}" = "true" ] || [ "${{ needs.checks.outputs.changed_shared }}" = "true" ]; then
              node scripts/release/bump-version.mjs --component server --bump "$bump" >/tmp/bump_server.txt
              bumped+=("server")
            fi
            if [ "${{ needs.checks.outputs.changed_website }}" = "true" ]; then
              node scripts/release/bump-version.mjs --component website --bump "$bump" >/tmp/bump_website.txt
              bumped+=("website")
            fi
          fi

          if [ "${{ inputs.cli_bump }}" != "none" ]; then
            node scripts/release/bump-version.mjs --component cli --bump "${{ inputs.cli_bump }}" >/tmp/bump_cli.txt
            bumped+=("cli")
          fi

          if [ "${{ inputs.stack_bump }}" != "none" ]; then
            BUMP="${{ inputs.stack_bump }}" node - <<'NODE' >/tmp/bump_stack.txt
            const fs = require('node:fs');
            const pkgPath = 'apps/stack/package.json';
            const bump = String(process.env.BUMP || '').trim();

            const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
            const raw = String(pkg.version ?? '').trim();
            const m = /^(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(raw);
            if (!m) throw new Error(`Invalid semver "${raw}"`);

            let major = Number(m[1]);
            let minor = Number(m[2]);
            let patch = Number(m[3]);

            if (bump === 'major') {
              major += 1;
              minor = 0;
              patch = 0;
            } else if (bump === 'minor') {
              minor += 1;
              patch = 0;
            } else if (bump === 'patch') {
              patch += 1;
            } else {
              throw new Error(`Unknown bump "${bump}"`);
            }

            const next = `${major}.${minor}.${patch}`;
            pkg.version = next;
            fs.writeFileSync(pkgPath, `${JSON.stringify(pkg, null, 2)}\n`);
            process.stdout.write(`${next}\n`);
            NODE
            bumped+=("stack")
          fi

          if [ "${#bumped[@]}" -eq 0 ]; then
            echo "No version bumps requested." >> "$GITHUB_STEP_SUMMARY"
            echo "did_bump=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "did_bump=true" >> "$GITHUB_OUTPUT"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add apps/ui/package.json apps/ui/app.config.js apps/server/package.json apps/website/package.json apps/cli/package.json apps/stack/package.json || true

          # Also pick up any tauri version edits if present.
          if [ -d apps/ui/src-tauri ]; then
            git add apps/ui/src-tauri || true
          fi

          git commit -m "chore(release): bump versions (${bumped[*]})"
          git push origin HEAD:main

  deploy_ui:
    if: inputs.dry_run != true && inputs.deploy_ui == true && needs.deploy_plan.outputs.deploy_ui_needed == 'true'
    needs: [checks, promote_main, bump_versions, deploy_plan]
    uses: ./.github/workflows/promote-ui.yml
    secrets: inherit
    with:
      environment: ${{ inputs.environment }}
      source_ref: main
      allow_cross_promote: false
      bump: none
      deploy_web: true
      expo_action: ${{ inputs.ui_expo_action }}
      expo_profile: ${{ inputs.ui_expo_profile }}
      expo_platform: ${{ inputs.ui_expo_platform }}
      run_tests: false

  deploy_server:
    if: inputs.dry_run != true && inputs.deploy_server == true && needs.deploy_plan.outputs.deploy_server_needed == 'true'
    needs: [checks, promote_main, bump_versions, deploy_plan]
    uses: ./.github/workflows/promote-server.yml
    secrets: inherit
    with:
      environment: ${{ inputs.environment }}
      source_ref: main
      allow_cross_promote: false
      bump: none
      run_tests: false

  deploy_website:
    if: inputs.dry_run != true && inputs.deploy_website == true && needs.deploy_plan.outputs.deploy_website_needed == 'true'
    needs: [checks, promote_main, bump_versions, deploy_plan]
    uses: ./.github/workflows/promote-website.yml
    secrets: inherit
    with:
      environment: ${{ inputs.environment }}
      source_ref: main
      allow_cross_promote: false
      bump: none
      run_build: true

  deploy_docs:
    if: inputs.dry_run != true && inputs.deploy_docs == true && needs.deploy_plan.outputs.deploy_docs_needed == 'true'
    needs: [checks, promote_main, bump_versions, deploy_plan]
    uses: ./.github/workflows/promote-docs.yml
    secrets: inherit
    with:
      environment: ${{ inputs.environment }}
      source_ref: main
      allow_cross_promote: false
      run_build: true

  publish_npm:
    if: inputs.dry_run != true && (inputs.cli_bump != 'none' || inputs.stack_bump != 'none')
    needs: [checks, promote_main, bump_versions]
    uses: ./.github/workflows/release-npm.yml
    secrets: inherit
    with:
      publish_cli: ${{ inputs.cli_bump != 'none' }}
      publish_stack: ${{ inputs.stack_bump != 'none' }}
      channel: ${{ inputs.environment }}
      bump: none
      stack_bump: none
      npm_tag: ${{ inputs.environment == 'production' && 'latest' || 'next' }}
      run_tests: false
      update_deploy_branch: ${{ inputs.cli_bump != 'none' || inputs.stack_bump != 'none' }}

  sync_dev:
    if: inputs.dry_run != true && inputs.sync_dev_from_main == true
    needs: [checks, promote_main, bump_versions]
    uses: ./.github/workflows/promote-branch.yml
    secrets: inherit
    with:
      source: main
      target: dev
      mode: fast_forward
      dry_run: false
      allow_reset: false
      confirm: promote dev from main
