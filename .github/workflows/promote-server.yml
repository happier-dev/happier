name: PROMOTE — Server (deploy branch)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target — Environment (deploy branch)"
        required: true
        type: choice
        options:
          - preview
          - production
      run_tests:
        description: "Checks — Run apps/server tests before promoting"
        required: true
        default: true
        type: boolean
      source_ref:
        description: "Promotion — Source ref to promote (branch, tag, or SHA). Use 'auto' to default preview→dev, production→main."
        required: true
        default: auto
        type: string
      allow_cross_promote:
        description: "Safety — Allow promoting a non-default source ref to the selected environment (use with care)."
        required: true
        default: false
        type: boolean
      bump:
        description: "Versions — Version bump on source ref (server)"
        required: true
        default: none
        type: choice
        options:
          - none
          - patch
          - minor
          - major
  workflow_call:
    inputs:
      environment:
        description: "Target — Environment (deploy branch)"
        required: true
        type: string
      run_tests:
        description: "Checks — Run apps/server tests before promoting"
        required: false
        default: true
        type: boolean
      source_ref:
        description: "Promotion — Source ref to promote (branch, tag, or SHA). Use 'auto' to default preview→dev, production→main."
        required: false
        default: auto
        type: string
      allow_cross_promote:
        description: "Safety — Allow promoting a non-default source ref to the selected environment (use with care)."
        required: false
        default: false
        type: boolean
      bump:
        description: "Versions — Version bump on source ref (server)"
        required: false
        default: none
        type: string

permissions:
  contents: read

concurrency:
  group: promote-server-${{ github.ref }}
  cancel-in-progress: false

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve source ref
        id: resolve
        run: |
          set -euo pipefail
          env_name="${{ inputs.environment }}"
          src="${{ inputs.source_ref }}"
          if [ "$src" = "auto" ]; then
            if [ "$env_name" = "preview" ]; then
              src="dev"
            else
              src="main"
            fi
          fi

          # Guardrails: allow using non-default source ref only when explicitly confirmed.
          if [ "$env_name" = "production" ] && [ "$src" != "main" ] && [ "${{ inputs.allow_cross_promote }}" != "true" ]; then
            echo "Refusing to promote '$src' to production without allow_cross_promote=true." >&2
            exit 1
          fi

          # Bumps require a real branch target we can push back to.
          if [ "${{ inputs.bump }}" != "none" ] && [ "$src" != "main" ] && [ "$src" != "dev" ]; then
            echo "Refusing to bump versions when source_ref is not a branch (main/dev). Set bump=none or use a branch." >&2
            exit 1
          fi

          echo "ref=$src" >> "$GITHUB_OUTPUT"

      - name: Create GitHub App token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - name: Checkout source ref
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.resolve.outputs.ref }}
          fetch-depth: 0
          token: ${{ steps.app_token.outputs.token }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Install dependencies
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: yarn install --frozen-lockfile --ignore-engines

      - name: Bump server version (source ref)
        id: bump_server
        run: |
          set -euo pipefail
          out="$(node scripts/release/bump-version.mjs --component server --bump "${{ inputs.bump }}")"
          if [ "$out" = "SKIP" ]; then
            echo "skipped=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "skipped=false" >> "$GITHUB_OUTPUT"
          echo "version=$out" >> "$GITHUB_OUTPUT"

      - name: Run server tests
        if: inputs.run_tests
        run: yarn --cwd apps/server test

      - name: Commit version bump (source ref)
        if: steps.bump_server.outputs.skipped != 'true'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apps/server/package.json
          git commit -m "chore(release): bump server to v${{ steps.bump_server.outputs.version }}"

      - name: Push source ref (only for branches)
        if: steps.bump_server.outputs.skipped != 'true'
        run: |
          set -euo pipefail
          src="${{ steps.resolve.outputs.ref }}"
          git push origin "HEAD:refs/heads/$src"

      - name: Promote source ref to deploy branch
        env:
          DEPLOY_REF: deploy/${{ inputs.environment }}/server
        run: |
          set -euo pipefail
          remote_sha="$(git ls-remote --heads origin "$DEPLOY_REF" | awk '{print $1}')"
          if [ -n "$remote_sha" ]; then
            git push origin HEAD:"$DEPLOY_REF" --force-with-lease="refs/heads/$DEPLOY_REF:$remote_sha"
          else
            git push origin HEAD:"$DEPLOY_REF"
          fi
