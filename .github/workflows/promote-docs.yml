name: PROMOTE — Docs (deploy branch)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (deploy branch)"
        required: true
        type: choice
        options:
          - preview
          - production
      source_ref:
        description: "Source ref to promote (branch, tag, or SHA). Use 'auto' to default preview→dev, production→main."
        required: true
        default: auto
        type: string
      allow_cross_promote:
        description: "Allow promoting a non-default source ref to the selected environment (use with care)."
        required: true
        default: false
        type: boolean
      run_build:
        description: "Run docs build before promoting"
        required: true
        default: true
        type: boolean
  workflow_call:
    inputs:
      environment:
        description: "Target environment (deploy branch)"
        required: true
        type: string
      source_ref:
        description: "Source ref to promote (branch, tag, or SHA). Use 'auto' to default preview→dev, production→main."
        required: false
        default: auto
        type: string
      allow_cross_promote:
        description: "Allow promoting a non-default source ref to the selected environment (use with care)."
        required: false
        default: false
        type: boolean
      run_build:
        description: "Run docs build before promoting"
        required: false
        default: true
        type: boolean

permissions:
  contents: read

concurrency:
  group: promote-docs-${{ github.ref }}
  cancel-in-progress: false

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve source ref
        id: resolve
        run: |
          set -euo pipefail
          env_name="${{ inputs.environment }}"
          src="${{ inputs.source_ref }}"
          if [ "$src" = "auto" ]; then
            if [ "$env_name" = "preview" ]; then
              src="dev"
            else
              src="main"
            fi
          fi

          # Guardrails: allow using non-default source ref only when explicitly confirmed.
          if [ "$env_name" = "production" ] && [ "$src" != "main" ] && [ "${{ inputs.allow_cross_promote }}" != "true" ]; then
            echo "Refusing to promote '$src' to production without allow_cross_promote=true." >&2
            exit 1
          fi

          echo "ref=$src" >> "$GITHUB_OUTPUT"

      - name: Create GitHub App token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - name: Checkout source ref
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.resolve.outputs.ref }}
          fetch-depth: 0
          token: ${{ steps.app_token.outputs.token }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Enable Corepack (Yarn)
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate

      - name: Install dependencies
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: yarn install --frozen-lockfile --ignore-engines

      - name: Build docs
        if: inputs.run_build
        run: yarn workspace docs build

      - name: Promote source ref to deploy branch
        env:
          DEPLOY_REF: deploy/${{ inputs.environment }}/docs
        run: |
          set -euo pipefail
          remote_sha="$(git ls-remote --heads origin "$DEPLOY_REF" | awk '{print $1}')"
          if [ -n "$remote_sha" ]; then
            git push origin HEAD:"$DEPLOY_REF" --force-with-lease="refs/heads/$DEPLOY_REF:$remote_sha"
          else
            git push origin HEAD:"$DEPLOY_REF"
          fi
