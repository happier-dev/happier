name: CI — Tests

on:
  pull_request:
  push:
  workflow_dispatch:
    inputs:
      run_ui:
        description: "Unit — Run UI tests (apps/ui)"
        required: true
        default: true
        type: boolean
      run_server:
        description: "Unit — Run Server tests (apps/server)"
        required: true
        default: true
        type: boolean
      run_cli:
        description: "Unit — Run CLI tests (apps/cli)"
        required: true
        default: true
        type: boolean
      run_stack:
        description: "Unit — Run Stack tests (apps/stack)"
        required: true
        default: true
        type: boolean
      run_typecheck:
        description: "Typecheck — Run repo typecheck (ui/cli/server)"
        required: true
        default: true
        type: boolean
      run_cli_daemon_e2e:
        description: "Integration — Run CLI+Server(light) daemon E2E"
        required: true
        default: true
        type: boolean
      run_e2e_core:
        description: "E2E — Run core e2e suite (pglite + sqlite)"
        required: true
        default: true
        type: boolean
      run_providers:
        description: "Providers — Run provider contract matrix (requires secrets)"
        required: true
        default: false
        type: boolean
      providers_preset:
        description: "Providers — Preset"
        required: true
        default: all
        type: choice
        options:
          - all
          - claude
          - codex
          - opencode
      providers_tier:
        description: "Providers — Tier"
        required: true
        default: smoke
        type: choice
        options:
          - smoke
          - extended
      providers_opencode_version:
        description: "Providers (OpenCode) — Version"
        required: true
        default: "1.1.52"
        type: string
      providers_opencode_sha256:
        description: "Providers (OpenCode) — SHA256 for linux-x64-baseline tar.gz (empty to skip)"
        required: true
        default: "c7c1e622aff3d457358385e28dff33ffa8401cb9067e865a9f35a2f94e899490"
        type: string
      providers_strict_keys:
        description: "Providers — Fail on new fixture keys"
        required: true
        default: false
        type: boolean
      providers_flake_retry:
        description: "Providers — Retry once to classify flakes"
        required: true
        default: false
        type: boolean
      providers_update_baselines:
        description: "Providers — Update committed baselines (requires write access; not for PRs)"
        required: true
        default: false
        type: boolean
      run_stress:
        description: "Stress — Run stress suite (repeat/chaos)"
        required: true
        default: false
        type: boolean
      stress_repeat:
        description: "Stress — Repetitions (HAPPIER_E2E_REPEAT)"
        required: true
        default: "5"
        type: string
      stress_seed:
        description: "Stress — Seed (HAPPIER_E2E_SEED)"
        required: true
        default: ""
        type: string
  workflow_call:
    inputs:
      run_ui:
        required: false
        default: true
        type: boolean
      run_server:
        required: false
        default: true
        type: boolean
      run_cli:
        required: false
        default: true
        type: boolean
      run_stack:
        required: false
        default: true
        type: boolean
      run_typecheck:
        required: false
        default: true
        type: boolean
      run_cli_daemon_e2e:
        required: false
        default: true
        type: boolean
      run_e2e_core:
        required: false
        default: true
        type: boolean
      run_providers:
        required: false
        default: false
        type: boolean
      providers_preset:
        required: false
        default: all
        type: string
      providers_tier:
        required: false
        default: smoke
        type: string
      providers_opencode_version:
        required: false
        default: "1.1.52"
        type: string
      providers_opencode_sha256:
        required: false
        default: "c7c1e622aff3d457358385e28dff33ffa8401cb9067e865a9f35a2f94e899490"
        type: string
      providers_strict_keys:
        required: false
        default: false
        type: boolean
      providers_flake_retry:
        required: false
        default: false
        type: boolean
      providers_update_baselines:
        required: false
        default: false
        type: boolean
      run_stress:
        required: false
        default: false
        type: boolean
      stress_repeat:
        required: false
        default: "5"
        type: string
      stress_seed:
        required: false
        default: ""
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ui:
    if: ${{ (github.event_name != 'workflow_dispatch' && github.event_name != 'workflow_call') || inputs.run_ui }}
    name: UI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (GitHub Actions)
        if: env.ACT != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Setup Node (act)
        if: env.ACT == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate

      - name: Install dependencies
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: yarn install --frozen-lockfile

      - name: Run tests
        run: yarn workspace @happier-dev/app test

  server:
    if: ${{ (github.event_name != 'workflow_dispatch' && github.event_name != 'workflow_call') || inputs.run_server }}
    name: Server Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (GitHub Actions)
        if: env.ACT != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Setup Node (act)
        if: env.ACT == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate

      - name: Install dependencies
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: yarn install --frozen-lockfile --ignore-engines

      - name: Run tests
        run: yarn workspace @happier-dev/server test

  cli:
    if: ${{ (github.event_name != 'workflow_dispatch' && github.event_name != 'workflow_call') || inputs.run_cli }}
    name: CLI Tests (incl. tmux integration)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      HAPPIER_CLI_TMUX_INTEGRATION: "1"
      HAPPIER_CLI_DAEMON_REATTACH_INTEGRATION: "1"
      HAPPIER_NO_BROWSER_OPEN: "1"
      TMPDIR: /tmp
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (GitHub Actions)
        if: env.ACT != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Setup Node (act)
        if: env.ACT == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate

      - name: Install system dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          APT_FLAGS="-o Acquire::Retries=3 -o Acquire::http::Timeout=30 -o Acquire::https::Timeout=30"
          if [ "${ACT:-}" = "true" ] || [ -d /var/run/act ]; then
            . /etc/os-release || true
            CODENAME="${VERSION_CODENAME:-noble}"
            ARCH="$(dpkg --print-architecture)"
            BASE_URL="http://ports.ubuntu.com/ubuntu-ports"
            if [ "${ARCH}" = "amd64" ]; then BASE_URL="http://archive.ubuntu.com/ubuntu"; fi
            if command -v sudo >/dev/null 2>&1; then
              sudo rm -f /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/*.sources || true
              echo "deb ${BASE_URL} ${CODENAME} main universe" | sudo tee /etc/apt/sources.list >/dev/null
            else
              rm -f /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/*.sources || true
              echo "deb ${BASE_URL} ${CODENAME} main universe" > /etc/apt/sources.list
            fi
          fi
          if command -v sudo >/dev/null 2>&1; then
            sudo apt-get ${APT_FLAGS} update
            sudo apt-get ${APT_FLAGS} install -y --no-install-recommends tmux
          else
            apt-get ${APT_FLAGS} update
            apt-get ${APT_FLAGS} install -y --no-install-recommends tmux
          fi
          tmux -V

      - name: Install dependencies
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: yarn install --frozen-lockfile --ignore-engines

      - name: Disable remote logging for CI (avoid hanging test process)
        run: |
          set -euo pipefail
          if [ -f apps/cli/.env.integration-test ]; then
            sed -i 's/^DANGEROUSLY_LOG_TO_SERVER_FOR_AI_AUTO_DEBUGGING=.*/DANGEROUSLY_LOG_TO_SERVER_FOR_AI_AUTO_DEBUGGING=/' apps/cli/.env.integration-test
            sed -i 's/^DEBUG=.*/DEBUG=/' apps/cli/.env.integration-test
          fi

      - name: Run tests
        run: yarn workspace @happier-dev/cli test

  stack:
    if: ${{ (github.event_name != 'workflow_dispatch' && github.event_name != 'workflow_call') || inputs.run_stack }}
    name: Stack Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Enable Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate

      - name: Install dependencies
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: yarn install --frozen-lockfile --ignore-engines

      - name: Run tests
        run: yarn --cwd apps/stack test

  typecheck:
    if: ${{ (github.event_name != 'workflow_dispatch' && github.event_name != 'workflow_call') || inputs.run_typecheck }}
    name: Typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Enable Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate

      - name: Install dependencies
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: yarn install --frozen-lockfile --ignore-engines

      - name: Run typecheck
        run: yarn typecheck

  cli-daemon-e2e:
    if: ${{ (github.event_name != 'workflow_dispatch' && github.event_name != 'workflow_call') || inputs.run_cli_daemon_e2e }}
    name: CLI + Server (light/pglite) E2E
    runs-on: ubuntu-latest
    timeout-minutes: 35
    env:
      PORT: "3005"
      HAPPIER_SERVER_URL: http://localhost:3005
      HAPPIER_WEBAPP_URL: http://localhost:3005
      HAPPIER_HOME_DIR: /tmp/happier-dev-test
      DANGEROUSLY_LOG_TO_SERVER_FOR_AI_AUTO_DEBUGGING: "true"
      HAPPIER_SERVER_LIGHT_DATA_DIR: /tmp/happier-server-light
      # Fall back to a deterministic non-secret for forks / untrusted PRs (no access to repo secrets).
      HANDY_MASTER_SECRET: ${{ secrets.CI_MASTER_SECRET != '' && secrets.CI_MASTER_SECRET || 'happier-ci-master-secret-not-a-real-secret' }}
      HAPPIER_NO_BROWSER_OPEN: "1"
      TMPDIR: /tmp
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (GitHub Actions)
        if: env.ACT != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Setup Node (act)
        if: env.ACT == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate

      - name: Install system dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          APT_FLAGS="-o Acquire::Retries=3 -o Acquire::http::Timeout=30 -o Acquire::https::Timeout=30"
          if [ "${ACT:-}" = "true" ] || [ -d /var/run/act ]; then
            . /etc/os-release || true
            CODENAME="${VERSION_CODENAME:-noble}"
            ARCH="$(dpkg --print-architecture)"
            BASE_URL="http://ports.ubuntu.com/ubuntu-ports"
            if [ "${ARCH}" = "amd64" ]; then BASE_URL="http://archive.ubuntu.com/ubuntu"; fi
            if command -v sudo >/dev/null 2>&1; then
              sudo rm -f /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/*.sources || true
              echo "deb ${BASE_URL} ${CODENAME} main universe" | sudo tee /etc/apt/sources.list >/dev/null
            else
              rm -f /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/*.sources || true
              echo "deb ${BASE_URL} ${CODENAME} main universe" > /etc/apt/sources.list
            fi
          fi
          if command -v sudo >/dev/null 2>&1; then
            sudo apt-get ${APT_FLAGS} update
            sudo apt-get ${APT_FLAGS} install -y --no-install-recommends tmux
          else
            apt-get ${APT_FLAGS} update
            apt-get ${APT_FLAGS} install -y --no-install-recommends tmux
          fi
          tmux -V

      - name: Prepare light DB (PGlite) + apply migrations
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: |
          set -euo pipefail
          yarn install --frozen-lockfile --ignore-engines
          yarn --cwd apps/server -s migrate:light:deploy

      - name: Build CLI
        run: yarn workspace @happier-dev/cli build

      - name: Install provider CLI stubs (CI only)
        run: |
          set -euo pipefail
          trap 'exit 0' TERM INT

          STUB_BIN_DIR="/tmp/ci-bin"
          mkdir -p "${STUB_BIN_DIR}"

          write_stub() {
            local name="$1"
            local version="$2"
            cat > "${STUB_BIN_DIR}/${name}" <<EOF
          #!/usr/bin/env bash
          set -euo pipefail

          case "\${1:-}" in
            --version|-v|version)
              echo "${version}"
              exit 0
              ;;
            --help|-h|help)
              echo "${name} (ci stub)"
              exit 0
              ;;
          esac

          # Some callers expect a long-running interactive process; do not exit.
          if [ -t 0 ]; then
            while true; do sleep 3600 & wait \$!; done
          else
            cat >/dev/null || true
            while true; do sleep 3600 & wait \$!; done
          fi
          EOF
            chmod +x "${STUB_BIN_DIR}/${name}"
          }

          write_stub "auggie" "0.0.0-ci-stub"
          write_stub "claude" "0.0.0-ci-stub"
          write_stub "codex" "0.0.0-ci-stub"
          write_stub "gemini" "0.0.0-ci-stub"
          write_stub "opencode" "0.0.0-ci-stub"

          echo "${STUB_BIN_DIR}" >> "${GITHUB_PATH}"
          export PATH="${STUB_BIN_DIR}:${PATH}"

          command -v auggie && auggie --version
          command -v claude && claude --version
          command -v codex && codex --version
          command -v gemini && gemini --version
          command -v opencode && opencode --version

      - name: Run daemon integration suite (with light server)
        run: |
          set -euo pipefail

          mkdir -p "${HAPPIER_SERVER_LIGHT_DATA_DIR}"

          nohup yarn --cwd apps/server start:light > "/tmp/happier-server-light.log" 2>&1 &
          SERVER_PID="$(jobs -p | tail -n 1 || true)"
          if [ -z "${SERVER_PID}" ]; then
            echo "Failed to start server process"
            tail -n 200 "/tmp/happier-server-light.log" || true
            exit 1
          fi
          echo "${SERVER_PID}" > "/tmp/happier-server-light.pid"

          cleanup() {
            if [ -n "${SERVER_PID:-}" ]; then
              kill "${SERVER_PID}" || true
            fi
          }
          trap cleanup EXIT

          for i in $(seq 1 60); do
            if curl -fsS "http://127.0.0.1:${PORT}/health" >/dev/null 2>&1; then
              # Require health to be stable (avoid flaking on a transient accept before the server is ready).
              sleep 1
              curl -fsS "http://127.0.0.1:${PORT}/health" >/dev/null 2>&1
              echo "Server is healthy (stable)"
              break
            fi
            sleep 1
          done

          if ! curl -fsS "http://127.0.0.1:${PORT}/health" >/dev/null 2>&1; then
            echo "Server failed to become healthy within timeout"
            tail -n 200 "/tmp/happier-server-light.log" || true
            exit 1
          fi

          # Create a real account + token via the normal `/v1/auth` flow (ed25519 signature),
          # then write the credentials file expected by `.env.integration-test`.
          (cd apps/server && node --input-type=module - <<'NODE'
          import fs from "node:fs";
          import os from "node:os";
          import path from "node:path";
          import nacl from "tweetnacl";

          const keyPair = nacl.sign.keyPair();
          const challenge = nacl.randomBytes(32);
          const signature = nacl.sign.detached(challenge, keyPair.secretKey);
          const encode64 = (bytes) => Buffer.from(bytes).toString("base64");

          const serverUrl = process.env.HAPPIER_SERVER_URL || "http://127.0.0.1:3005";
          const url = new URL("/v1/auth", serverUrl);
          if (url.hostname === "localhost") url.hostname = "127.0.0.1";

          const res = await fetch(url.toString(), {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({
              publicKey: encode64(keyPair.publicKey),
              challenge: encode64(challenge),
              signature: encode64(signature),
            }),
          });
          if (!res.ok) {
            const text = await res.text().catch(() => "");
            console.error("Failed to create CI auth token:", res.status, res.statusText, text);
            process.exit(1);
          }
          const data = await res.json();
          if (!data?.token) {
            console.error("Auth response missing token:", data);
            process.exit(1);
          }

          const happierHomeDir = process.env.HAPPIER_HOME_DIR || path.join(os.homedir(), ".happier-dev-test");
          fs.mkdirSync(happierHomeDir, { recursive: true });
          const secret = Buffer.alloc(32, 7).toString("base64");
          fs.writeFileSync(
            path.join(happierHomeDir, "access.key"),
            JSON.stringify({ token: data.token, secret }, null, 2),
            { mode: 0o600 },
          );
          NODE
          )

          yarn --cwd apps/cli -s vitest run src/daemon/daemon.integration.test.ts

      - name: Dump server logs (on failure)
        if: failure()
        run: tail -n 300 "/tmp/happier-server-light.log" || true

      - name: Dump daemon logs (on failure)
        if: failure()
        run: |
          LOG_DIR="${HAPPIER_HOME_DIR:-$HOME/.happier-dev-test}/logs"
          ls -la "$LOG_DIR" || true
          ls -1t "$LOG_DIR"/*-daemon.log 2>/dev/null | head -n 8 | while read -r f; do
            echo "=== tail: $f ==="
            tail -n 200 "$f" || true
            echo
          done

  e2e-core:
    if: ${{ (github.event_name != 'workflow_dispatch' && github.event_name != 'workflow_call') || inputs.run_e2e_core }}
    name: Core E2E (packages/tests, server-light, ${{ matrix.db }})
    runs-on: ubuntu-latest
    timeout-minutes: 35
    strategy:
      fail-fast: false
      matrix:
        db: [pglite, sqlite]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (GitHub Actions)
        if: env.ACT != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Setup Node (act)
        if: env.ACT == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate

      - name: Install dependencies
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: yarn install --frozen-lockfile --ignore-engines

      - name: Run core e2e suite
        env:
          CI: "1"
          HAPPIER_E2E_SAVE_ARTIFACTS: "0"
          HAPPIER_E2E_DB_PROVIDER: ${{ matrix.db }}
        run: yarn test:e2e

      - name: Upload e2e artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: core-e2e-artifacts-${{ matrix.db }}
          path: .project/logs/e2e

  providers:
    if: ${{ (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.run_providers }}
    name: Providers (contract matrix)
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Enable Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate

      - name: Install dependencies
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: yarn install --frozen-lockfile --ignore-engines

      - name: Install provider CLIs
        env:
          PRESET: ${{ inputs.providers_preset }}
          OPENCODE_VERSION: ${{ inputs.providers_opencode_version }}
          OPENCODE_TARBALL_SHA256: ${{ inputs.providers_opencode_sha256 }}
        run: |
          set -euo pipefail

          need_claude=0
          need_codex=0
          need_opencode=0

          case "$PRESET" in
            all) need_claude=1; need_codex=1; need_opencode=1 ;;
            claude) need_claude=1 ;;
            codex) need_codex=1 ;;
            opencode) need_opencode=1 ;;
            *) echo "Unknown providers_preset: $PRESET" >&2; exit 2 ;;
          esac

          if [ "$need_claude" = "1" ]; then
            npm install -g @anthropic-ai/claude-code
            claude --version
          fi

          if [ "$need_codex" = "1" ]; then
            npm install -g @openai/codex
            codex --version
          fi

          if [ "$need_opencode" = "1" ]; then
            # Avoid `curl ... | bash` by downloading a pinned, checksummed release artifact.
            version="${OPENCODE_VERSION#v}"
            asset="opencode-linux-x64-baseline.tar.gz"
            url="https://github.com/anomalyco/opencode/releases/download/v${version}/${asset}"

            install_dir="$HOME/.opencode/bin"
            mkdir -p "$install_dir"

            tmp_dir="$(mktemp -d)"
            curl -fsSL -o "$tmp_dir/$asset" "$url"

            if [ -n "${OPENCODE_TARBALL_SHA256:-}" ]; then
              echo "${OPENCODE_TARBALL_SHA256}  $tmp_dir/$asset" | sha256sum -c -
            fi

            tar -xzf "$tmp_dir/$asset" -C "$tmp_dir"
            mv -f "$tmp_dir/opencode" "$install_dir/opencode"
            chmod 755 "$install_dir/opencode"
            rm -rf "$tmp_dir"

            echo "$install_dir" >> "$GITHUB_PATH"
            export PATH="$install_dir:$PATH"
            opencode --version
          fi

      - name: Validate provider auth env
        env:
          PRESET: ${{ inputs.providers_preset }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          set -euo pipefail

          need_openai=0
          need_anthropic=0

          case "$PRESET" in
            all) need_openai=1; need_anthropic=1 ;;
            codex) need_openai=1 ;;
            opencode) need_openai=1 ;;
            claude) need_anthropic=1 ;;
            *) echo "Unknown providers_preset: $PRESET" >&2; exit 2 ;;
          esac

          if [ "$need_openai" = "1" ] && [ -z "${OPENAI_API_KEY:-}" ] && [ -z "${CODEX_API_KEY:-}" ]; then
            echo "Missing provider secrets: set OPENAI_API_KEY (or CODEX_API_KEY) to run preset=$PRESET" >&2
            exit 1
          fi

          if [ "$need_anthropic" = "1" ] && [ -z "${ANTHROPIC_API_KEY:-}" ]; then
            echo "Missing provider secrets: set ANTHROPIC_API_KEY to run preset=$PRESET" >&2
            exit 1
          fi

      - name: Run provider contract suite
        env:
          CI: "1"
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          set -euo pipefail

          flags=()
          if [ "${{ inputs.providers_strict_keys }}" = "true" ]; then flags+=("--strict-keys"); fi
          if [ "${{ inputs.providers_flake_retry }}" = "true" ]; then flags+=("--flake-retry"); fi
          if [ "${{ inputs.providers_update_baselines }}" = "true" ]; then flags+=("--update-baselines"); fi

          yarn workspace @happier-dev/tests providers:run "${{ inputs.providers_preset }}" "${{ inputs.providers_tier }}" "${flags[@]}"

      - name: Upload provider artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: providers-artifacts
          path: .project/logs/e2e

  stress:
    if: ${{ (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.run_stress }}
    name: Stress (repeat/chaos)
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Enable Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate

      - name: Install dependencies
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: yarn install --frozen-lockfile --ignore-engines

      - name: Run stress suite
        env:
          CI: "1"
          HAPPIER_E2E_REPEAT: ${{ inputs.stress_repeat }}
          HAPPIER_E2E_SEED: ${{ inputs.stress_seed }}
          HAPPIER_E2E_FLAKE_RETRY: "1"
        run: yarn test:stress

      - name: Upload stress artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: stress-artifacts
          path: .project/logs/e2e
