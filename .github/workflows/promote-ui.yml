name: PROMOTE — UI (deploy branch + optional Expo)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target — Environment (deploy branch)"
        required: true
        type: choice
        options:
          - preview
          - production
      run_tests:
        description: "Checks — Run apps/ui tests before promoting"
        required: true
        default: true
        type: boolean
      source_ref:
        description: "Promotion — Source ref to promote (branch, tag, or SHA). Use 'auto' to default preview→dev, production→main."
        required: true
        default: auto
        type: string
      allow_cross_promote:
        description: "Safety — Allow promoting a non-default source ref to the selected environment (use with care)."
        required: true
        default: false
        type: boolean
      bump:
        description: "Versions — Version bump on source ref (app)"
        required: true
        default: none
        type: choice
        options:
          - none
          - patch
          - minor
          - major
      deploy_web:
        description: "Deploy — Promote deploy/<env>/ui (web deploy on push)"
        required: true
        default: true
        type: boolean
      expo_action:
        description: "Deploy (Expo) — Action (requires EXPO_TOKEN secret)"
        required: true
        default: none
        type: choice
        options:
          - none
          - ota
          - native
          - native_submit
      expo_profile:
        description: "Deploy (Expo) — EAS build profile (auto: preview→preview, production→production)"
        required: true
        default: auto
        type: choice
        options:
          - auto
          - preview
          - production
      expo_platform:
        description: "Deploy (Expo) — Native build platform"
        required: true
        default: ios
        type: choice
        options:
          - ios
          - android
          - all
  workflow_call:
    inputs:
      environment:
        description: "Target — Environment (deploy branch)"
        required: true
        type: string
      run_tests:
        description: "Checks — Run apps/ui tests before promoting"
        required: false
        default: true
        type: boolean
      source_ref:
        description: "Promotion — Source ref to promote (branch, tag, or SHA). Use 'auto' to default preview→dev, production→main."
        required: false
        default: auto
        type: string
      allow_cross_promote:
        description: "Safety — Allow promoting a non-default source ref to the selected environment (use with care)."
        required: false
        default: false
        type: boolean
      bump:
        description: "Versions — Version bump on source ref (app)"
        required: false
        default: none
        type: string
      deploy_web:
        description: "Deploy — Promote deploy/<env>/ui (web deploy on push)"
        required: false
        default: true
        type: boolean
      expo_action:
        description: "Deploy (Expo) — Action (requires EXPO_TOKEN secret)"
        required: false
        default: none
        type: string
      expo_profile:
        description: "Deploy (Expo) — EAS build profile (auto: preview→preview, production→production)"
        required: false
        default: auto
        type: string
      expo_platform:
        description: "Deploy (Expo) — Native build platform"
        required: false
        default: ios
        type: string

permissions:
  contents: read

concurrency:
  group: promote-ui-${{ github.ref }}
  cancel-in-progress: false

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve source ref
        id: resolve
        run: |
          set -euo pipefail
          env_name="${{ inputs.environment }}"
          src="${{ inputs.source_ref }}"
          if [ "$src" = "auto" ]; then
            if [ "$env_name" = "preview" ]; then
              src="dev"
            else
              src="main"
            fi
          fi

          # Guardrails: allow using non-default source ref only when explicitly confirmed.
          if [ "$env_name" = "production" ] && [ "$src" != "main" ] && [ "${{ inputs.allow_cross_promote }}" != "true" ]; then
            echo "Refusing to promote '$src' to production without allow_cross_promote=true." >&2
            exit 1
          fi

          # Bumps require a real branch target we can push back to.
          if [ "${{ inputs.bump }}" != "none" ] && [ "$src" != "main" ] && [ "$src" != "dev" ]; then
            echo "Refusing to bump versions when source_ref is not a branch (main/dev). Set bump=none or use a branch." >&2
            exit 1
          fi

          echo "ref=$src" >> "$GITHUB_OUTPUT"

      - name: Create GitHub App token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - name: Checkout source ref
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.resolve.outputs.ref }}
          fetch-depth: 0
          token: ${{ steps.app_token.outputs.token }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: Install dependencies
        env:
          YARN_PRODUCTION: "false"
          npm_config_production: "false"
        run: yarn install --frozen-lockfile --ignore-engines

      - name: Bump app version (source ref)
        id: bump_app
        run: |
          set -euo pipefail
          out="$(node scripts/release/bump-version.mjs --component app --bump "${{ inputs.bump }}")"
          if [ "$out" = "SKIP" ]; then
            echo "skipped=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "skipped=false" >> "$GITHUB_OUTPUT"
          echo "version=$out" >> "$GITHUB_OUTPUT"

      - name: Run app tests
        if: inputs.run_tests
        run: yarn --cwd apps/ui test

      - name: Commit version bump (source ref)
        if: steps.bump_app.outputs.skipped != 'true'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apps/ui/package.json apps/ui/app.config.js
          if [ -d apps/ui/src-tauri ]; then
            git add apps/ui/src-tauri || true
          fi
          git commit -m "chore(release): bump app to v${{ steps.bump_app.outputs.version }}"

      - name: Expo OTA update
        if: inputs.expo_action == 'ota'
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APP_ENV: ${{ inputs.environment }}
        run: |
          set -euo pipefail
          if [ -z "${EXPO_TOKEN:-}" ]; then
            echo "EXPO_TOKEN is required for Expo actions." >&2
            exit 1
          fi
          if [ "${{ inputs.environment }}" = "production" ]; then
            yarn --cwd apps/ui ota:production
          else
            yarn --cwd apps/ui ota
          fi

      - name: Resolve Expo build profile
        id: expo_profile
        if: inputs.expo_action == 'native' || inputs.expo_action == 'native_submit'
        run: |
          set -euo pipefail
          env_name="${{ inputs.environment }}"
          action="${{ inputs.expo_action }}"
          profile="${{ inputs.expo_profile }}"

          if [ "${profile}" = "auto" ]; then
            profile="${env_name}"
          fi

          echo "profile=${profile}" >> "$GITHUB_OUTPUT"
          {
            echo "### Expo"
            echo "- action: \`${action}\`"
            echo "- environment: \`${env_name}\`"
            echo "- build profile: \`${profile}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Expo native build
        if: inputs.expo_action == 'native' || inputs.expo_action == 'native_submit'
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APP_ENV: ${{ inputs.environment }}
        run: |
          set -euo pipefail
          if [ -z "${EXPO_TOKEN:-}" ]; then
            echo "EXPO_TOKEN is required for Expo actions." >&2
            exit 1
          fi
          cd apps/ui
          npx --yes eas-cli@latest build --platform "${{ inputs.expo_platform }}" --profile "${{ steps.expo_profile.outputs.profile }}" --non-interactive

      - name: Expo submit
        if: inputs.expo_action == 'native_submit'
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${EXPO_TOKEN:-}" ]; then
            echo "EXPO_TOKEN is required for Expo actions." >&2
            exit 1
          fi
          cd apps/ui
          npx --yes eas-cli@latest submit --platform "${{ inputs.expo_platform }}" --latest --non-interactive

      - name: Push source ref (only for branches)
        if: steps.bump_app.outputs.skipped != 'true'
        run: |
          set -euo pipefail
          src="${{ steps.resolve.outputs.ref }}"
          git push origin "HEAD:refs/heads/$src"

      - name: Promote source ref to deploy branch (web)
        if: inputs.deploy_web
        env:
          DEPLOY_REF: deploy/${{ inputs.environment }}/ui
        run: |
          set -euo pipefail
          remote_sha="$(git ls-remote --heads origin "$DEPLOY_REF" | awk '{print $1}')"
          if [ -n "$remote_sha" ]; then
            git push origin HEAD:"$DEPLOY_REF" --force-with-lease="refs/heads/$DEPLOY_REF:$remote_sha"
          else
            git push origin HEAD:"$DEPLOY_REF"
          fi
