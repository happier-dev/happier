<!-- EDISON:START -->
<!-- GENERATED BY EDISON - DO NOT EDIT -->
<!-- Source: core + pack(happy-stacks) + pack(expo) + pack(typescript) + pack(react) + pack(prisma) + pack(e2e-web) -->
<!-- Regenerate: edison compose all -->

# Edison Framework

## MANDATORY: Constitution

**This is a MANDATORY READ.** You MUST read your role-specific constitution file FIRST before any work.

### Re-Read Requirements

**You MUST re-read your constitution:**
- At the START of every new session
- After ANY context compaction
- Whenever you notice the constitution is no longer in your context
- When instructed by the user

### Constitution Locations

| Your Role | Constitution File |
|-----------|-------------------|
| Orchestrator | `edison read ORCHESTRATOR --type constitutions` |
| Agent (Implementer) | `edison read AGENTS --type constitutions` |
| Validator | `edison read VALIDATORS --type constitutions` |

**Determine your role from the task assignment, then read the appropriate constitution.**

## Role Determination

- **Orchestrator**: You are coordinating work, delegating tasks, managing sessions
- **Agent**: You are implementing features, writing code, fixing bugs
- **Validator**: You are reviewing code, validating changes, running checks

---

**DO NOT PROCEED WITHOUT READING YOUR CONSTITUTION FIRST.**
<!-- EDISON:END -->

# Agent / Contributor Guide (hapsta)

Hapsta is designed for:

- running the **Happier** stack locally (server + UI + CLI/daemon)
- accessing it remotely (recommended: **Tailscale Serve** for HTTPS secure context)
- developing on Happier in a single monorepo using **repo worktrees**
- running multiple isolated instances via **stacks**
- maintaining a **patched fork** while still producing **clean upstream PRs**

If you are an LLM agent: treat this file as the “ground truth” for workflows, naming, and commands.

---

## Big picture (what lives where)

### This package (`@happier-dev/stack`)

- `scripts/*.mjs`: orchestration CLIs (setup/bootstrap, run/dev/build, stacks, worktrees, service, tailscale, mobile, tools).

### Your local installation (defaults)

- Home: `~/.happier-stack`
- Workspace: `~/.happier-stack/workspace`
- Default repo checkout: `<workspace>/happier`
- Worktrees root: `<workspace>/.worktrees`
- Stack storage: `~/.happier/stacks/<stack>/...` (stack env file: `~/.happier/stacks/<stack>/env`)

### Happier monorepo

- `apps/ui` (UI)
- `apps/cli` (CLI + daemon)
- `apps/server` (server; light/full flavors)

---

## Non-negotiables (agents)

### Command discipline (only use `hapsta ...`)

Use Hapsta for everything:

- `hapsta start` / `hapsta dev`
- `hapsta typecheck` / `hapsta lint` / `hapsta test` / `hapsta build`
- `hapsta stack ...` (isolated stacks)
- `hapsta wt ...` (repo worktrees)
- `hapsta tailscale ...` / `hapsta service ...`
- `hapsta tools ...` (setup-pr/review-pr/import/review/edison)

Do not run these directly in the monorepo:

- `yarn dev`, `yarn start`, `expo ...`, `tsc`, `eslint`, `docker compose ...`
- raw `git worktree ...` (use `hapsta wt ...`)

If you’re tempted to run a low-level command, route it through `hapsta` (or add a `hapsta` subcommand).

### You must develop in worktrees only

- Do **not** develop directly in the default checkout (typically `<workspace>/happier`).
  - Treat it as **read-only** “launcher defaults”.
- All changes should happen inside:
  - `<workspace>/.worktrees/<owner>/<branch...>` (created/managed by `hapsta wt ...`)

### You must test changes inside isolated stacks

- When testing a feature/PR, create an isolated stack and point it at your worktree:
  - `hapsta stack new exp1 --interactive`
  - `hapsta stack wt exp1 -- use <owner/branch|/abs/path>`
- Avoid editing `env.local` by hand; prefer stack env files and `hapsta stack env ...`.

---

## Worktrees (monorepo-only)

### Layout

All worktrees live under:

```
<workspace>/.worktrees/<owner>/<branch...>
```

Examples:

- `<workspace>/.worktrees/slopus/pr/123-fix-thing`
- `<workspace>/.worktrees/happier-dev/local/my-patch`

### Common commands

- Create: `hapsta wt new pr/my-feature --from=upstream --use`
- PR checkout: `hapsta wt pr 123 --use`
- Switch active checkout: `hapsta wt use slopus/pr/123-fix-thing`
- List/status: `hapsta wt list` / `hapsta wt status`

### Targeting a worktree without mutating a stack

Pass a one-shot override:

- `hapsta stack typecheck <stack> --repo=<owner/branch|/abs/path>`
- `hapsta stack build <stack> --repo=<owner/branch|/abs/path>`

---

## Main stack safety

The default stack (`main`) is meant to stay stable.

By default, `hapsta wt use` refuses to repoint `main` to an arbitrary worktree/path. Recommended flow:

- Create a new stack and switch that stack:
  - `hapsta stack new exp1 --interactive`
  - `hapsta stack wt exp1 -- use slopus/pr/my-branch`

Override (only if you really mean it):

- `hapsta wt use slopus/pr/my-branch --force`

---

## Safety invariants (must not regress)

These are intentional safety properties. Preserve them unless explicitly redesigning them.

### Process isolation (stacks)

- Never kill by port in stack mode.
- Stack stop/restart must kill only stack-owned processes (PIDs recorded in `stack.runtime.json` / stack markers).

### Ephemeral ports (non-main stacks)

- Non-main stacks pick ports at start time; ports are recorded in `stack.runtime.json`.
- `--restart` must reuse previous runtime ports or fail closed if occupied.

### Watch mode

- Watcher restarts must be stack-owned (PID verified). Unknown PIDs must not be restarted.

### Tailscale Serve

- Do not auto-enable/repoint Tailscale Serve for non-main stacks by default.

### Daemons

- Multiple daemons are expected (one per stack).
- Never “fix” issues by killing all daemons.

---

## Auth + secrets

- Configure a seed stack once (recommended: `dev-auth`).
- New stacks can reuse auth without re-login:
  - `hapsta stack auth <name> copy-from dev-auth`

Environment knobs:

- `HAPPIER_STACK_AUTH_SEED_FROM=<seed>`
- `HAPPIER_STACK_AUTO_AUTH_SEED=1`

---

## Commit messages (Conventional Commits)

Use Conventional Commits for all commits (and for squash messages):

```text
<type>[optional scope][!]: <description>
```

Types: `feat`, `fix`, `docs`, `refactor`, `test`, `chore`, `build`, `ci`, `perf`, `revert`
